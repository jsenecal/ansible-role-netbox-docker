---
- name: Create the volumes folders on the host
  file:
    path: "{{item.source}}"
    state: directory
  loop: "{{netbox_volumes}}"
  when: item.source is defined and item.type == 'bind'

- name: Ensure required netbox directories exist
  ansible.builtin.file:
    path: "{{ netbox_base_path }}/{{ item }}"
    state: directory
    recurse: true
  loop:
    - env
    - db
    - backups

- name: Generate environment files for netbox and related containers
  ansible.builtin.template:
    src: "env/{{ item }}.j2"
    dest: "{{ netbox_base_path }}/env/{{ item }}"
    mode: "0644"
  loop:
    - netbox.env
    - postgres.env
    - valkey-cache.env
    - valkey.env
    - pgbackups.env
  notify: Restart netbox

- name: Generate configuration files from templates
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ netbox_base_path }}/{{ item }}"
    mode: "0644"
  loop:
    - docker-compose.yml
    - extra.py
    - Caddyfile
    - nginx-unit.json
  notify: Restart netbox
